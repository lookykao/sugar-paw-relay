<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <title>Auth Relay · SugarPaw</title>
    <meta name="robots" content="noindex,nofollow" />
    <style>
      :root { --bg:#fff8f3; --card:#fff; --muted:#888; }
      html,body { height:100%; }
      body {
        margin:0; display:grid; place-items:center; height:100%;
        background:var(--bg); color:#333;
        font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
      }
      .card {
        background:var(--card); border:1px solid #eee; border-radius:16px;
        padding:20px 24px; box-shadow:0 6px 24px rgba(0,0,0,.06); text-align:left; width:min(680px, 92vw);
      }
      .row { display:flex; gap:8px; align-items:center; justify-content:space-between; }
      .muted { color:var(--muted); font-size:12px; }
      code { background:#f6f6f6; padding:2px 6px; border-radius:6px; }
      .kv { margin:8px 0; }
      .kv dt { font-size:12px; color:#666; }
      .kv dd { margin:2px 0 10px; word-break:break-all; }
      .hide { display:none; }
      .ok { color:#10b981; font-weight:600; }
    </style>
  </head>
  <body>
    <div class="card" id="panel" class="hide">
      <div class="row">
        <div><strong>正在安全轉跳中…</strong></div>
        <div class="muted" id="timerText">即將跳轉</div>
      </div>
      <div class="muted">若未自動跳轉，請稍候或手動返回 App</div>
      <dl class="kv">
        <dt>origin</dt>
        <dd><code id="originEl"></code></dd>
        <dt>next</dt>
        <dd><code id="nextEl"></code></dd>
        <dt>hash（access_token 等）</dt>
        <dd><code id="hashEl"></code></dd>
        <dt>完整目標</dt>
        <dd><code id="targetEl"></code></dd>
      </dl>
      <div class="muted">/auth/relay → /auth/callback</div>
      <div id="okMsg" class="ok hide">✓ 3 秒後跳轉（debug 模式）</div>
    </div>

    <script>
      (function () {
        // 你的主站（處理 /auth/callback 的站點）
        const DEFAULT_ORIGIN = "https://sugar-paw.vercel.app";

        // 解析參數
        const url = new URL(window.location.href);
        const origin = (url.searchParams.get("origin") || DEFAULT_ORIGIN).replace(/\/+$/, "");
        const search = window.location.search || "";
        const hash = window.location.hash || "";
        const target = `${origin}/auth/callback${search}${hash}`;

        // Debug 開關與延遲（只有 ?debug=1 時才會啟用）
        const DEBUG = url.searchParams.get("debug") === "1";
        const DEBUG_DELAY_MS = 3000;

        // 更新 UI
        const $ = (id) => document.getElementById(id);
        $("originEl").textContent = origin;
        $("nextEl").textContent = url.searchParams.get("next") || "(無 next)";
        $("hashEl").textContent = hash || "(無 #hash)";
        $("targetEl").textContent = target;

        if (DEBUG) {
          $("okMsg").classList.remove("hide");
          let remain = Math.ceil(DEBUG_DELAY_MS / 1000);
          $("timerText").textContent = `即將跳轉（${remain}s）`;
          $("panel").classList.remove("hide");

          const tick = setInterval(() => {
            remain -= 1;
            if (remain <= 0) {
              clearInterval(tick);
              go();
            } else {
              $("timerText").textContent = `即將跳轉（${remain}s）`;
            }
          }, 1000);

          setTimeout(go, DEBUG_DELAY_MS);
        } else {
          // 非 debug 直接跳
          go();
        }

        function go() {
          try { window.location.replace(target); }
          catch { window.location.href = target; }
        }
      })();
    </script>
  </body>
</html>
